#!/bin/bash

# æµ‹è¯•ç™½æ¿åŒæ­¥åŠŸèƒ½çš„è„šæœ¬

echo "ğŸ§ª å¼€å§‹æµ‹è¯•ç™½æ¿DDSåŒæ­¥åŠŸèƒ½..."

# æ£€æŸ¥å¿…è¦çš„ç»„ä»¶
echo "ğŸ“‹ æ£€æŸ¥ç»„ä»¶çŠ¶æ€..."

# 1. æ£€æŸ¥DDSè®¢é˜…è€…
echo "1ï¸âƒ£ å¯åŠ¨DDSè®¢é˜…è€…ï¼ˆåå°ï¼‰..."
cd dds_subscriber
cargo run -- listen --verbose &
SUBSCRIBER_PID=$!
cd ..

# ç­‰å¾…è®¢é˜…è€…å¯åŠ¨
sleep 2

# 2. å¯åŠ¨æµ‹è¯•å‘å¸ƒè€…
echo "2ï¸âƒ£ å¯åŠ¨æµ‹è¯•å‘å¸ƒè€…ï¼ˆåå°ï¼‰..."
cd test_publisher
cargo run &
PUBLISHER_PID=$!
cd ..

# ç­‰å¾…å‘å¸ƒè€…å¯åŠ¨
sleep 2

# 3. å¯åŠ¨ä¸»åº”ç”¨
echo "3ï¸âƒ£ å¯åŠ¨ä¸»åº”ç”¨..."
echo "è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åº”ç”¨ï¼Œè¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š"
echo "   - åˆ›å»ºå‡ ä½•å›¾å½¢ï¼ˆçŸ©å½¢ã€åœ†å½¢ç­‰ï¼‰"
echo "   - æ‹–åŠ¨å’Œè°ƒæ•´å›¾å½¢"
echo "   - æ·»åŠ æ–‡æœ¬"
echo "   - åˆ é™¤å…ƒç´ "
echo "   - è§‚å¯Ÿå³ä¾§æ—¥å¿—é¢æ¿çš„DDSåŒæ­¥ä¿¡æ¯"
echo ""
echo "ğŸ’¡ æç¤ºï¼šå¯ä»¥åŒæ—¶æ‰“å¼€å¤šä¸ªæµè§ˆå™¨çª—å£æµ‹è¯•å¤šç”¨æˆ·åä½œ"
echo ""
echo "æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æµ‹è¯•è¿›ç¨‹"

# å¯åŠ¨ä¸»åº”ç”¨
npm run dev

# æ¸…ç†å‡½æ•°
cleanup() {
    echo ""
    echo "ğŸ§¹ æ¸…ç†æµ‹è¯•è¿›ç¨‹..."
    kill $SUBSCRIBER_PID 2>/dev/null
    kill $PUBLISHER_PID 2>/dev/null
    echo "âœ… æµ‹è¯•å®Œæˆ"
    exit 0
}

# æ•è·ä¸­æ–­ä¿¡å·
trap cleanup SIGINT SIGTERM

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
wait